# Сервис сокращения ссылок
![Java](https://img.shields.io/badge/java-%23ED8B00.svg?style=for-the-badge&logo=openjdk&logoColor=white)
![Gradle](https://img.shields.io/badge/gradle-02303A?style=for-the-badge&logo=gradle&logoColor=white)
![Json](https://img.shields.io/badge/json-5E5C5C?style=for-the-badge&logo=json&logoColor=white)
![JUnit](https://img.shields.io/badge/Junit5-25A162?style=for-the-badge&logo=junit5&logoColor=white)

![GitHub Actions](https://img.shields.io/badge/GitHub_Actions-2088FF?logo=github-actions&logoColor=white)
![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/yuyuvu/url-shortener-service/check-test-build.yml)

## Краткое описание сервиса:

Сервис сокращения ссылок позволяет вводить в консоль URL и получать в ответ короткую ссылку
сервиса, которую можно использовать для перехода по оригинальному URL.
Для сокращения нужно ввести URL, не являющийся URL сервиса сокращения ссылок, в консоль;
для использования уже имеющейся короткой ссылки её также нужно просто ввести в консоль,
и автоматически откроется браузер для перенаправления на изначальный длинный URL.
Помимо ввода ссылок, пользователь может вводить различные команды, позволяющие ему получать
доступ к дополнительному функционалу сервиса (список всех команд и их возможностей отображается
в выводе команды help).

## Сервис реализует следующий функционал:

1.  При первом вводе URL создаёт для пользователя уникальный UUID для идентификации.
2.  Позволяет идентифицироваться в сервисе при помощи ввода login uuid_пользователя,
    что позволяет создателю конкретных коротких ссылок управлять их параметрами.
3.  Задаёт для коротких ссылок лимит их использований и срок действия по умолчанию, которые
    читаются из внешнего файла конфигурации. При израсходовании лимита возможность перехода
    по короткой ссылке блокируется. При истечении срока действия ссылки она автоматически
    удаляется из хранилища сервиса.
4.  Не позволяет пользователям иметь одинаковые короткие ссылки, что гарантирует защиту от
    коллизий и ситуаций, когда одна и та же ссылка указывает на разные сайты, или несколько
    коротких ссылок указывают на один и тот же сайт. Эта защита обеспечивается как для одного
    пользователя, так и глобально по всему сервису.
5.  В фоновом режиме периодически (раз в 15 секунд) проверяет все ссылки на предмет
    израсходования лимита или истечения срока действия. Создаёт уведомления для пользователя
    в случае наступления данных событий. Удаляет устаревшие ссылки.
6.  Если пользователь идентифицировался в сервисе, ему в фоновом режиме (в течение 20-30 секунд)
    приходят все ранее созданные и непрочитанные уведомления. Если пользователь не
    идентифицировался, уведомления будут продолжать храниться в сервисе и будут отправлены
    сразу, как пользователь идентифицируется в следующий раз.
7.  Сервис сохраняет своё состояние между перезапусками, все данные при выключении сохраняются
    в файл, при включении - загружаются из него. Для выключения можно использовать команду
    exit.
8.  Система позволяет пользователю изменять отдельные параметры ранее созданных им коротких
    ссылок: лимит использований; срок действия с момента создания ссылки; длинный URL, на который
    ведёт ссылка. Значения не могут быть выставлены больше определённых лимитов, читаемых из
    конфигурации (команда manage с её подкомандами).
9.  Создатель ссылки может удалить её раньше срока действия (команда delete).
10. Создатель ссылки может посмотреть список всех созданных ссылок, связанных с UUID,
    по которому сейчас осуществляется идентификация (команда list).
11. Создатель ссылки может посмотреть статистику использования всех (stats) или отдельной
    (stats вместе_с_URL) созданной им короткой ссылки.
12. Пользователь может получить помощь по всему сервису (help) или по отдельной команде
    (help имя_команды).
13. Сервис считывает параметры, устанавливаемые по умолчанию, из внешнего файла конфигурации.
    Например, единицу измерения TTL (стандартно часы), длину ID короткой ссылки, разрешённые
    в коде короткой ссылки символы, лимиты, путь до файла хранилища данных и т.д.
    Относительный путь до файла настроек: url_shortener_appdata/url_shortener_config.properties.
14. Настройки сервиса могут быть перезагружены после их изменения в файле без перезапуска
    при помощи ввода команды config reload.
15. Можно снять идентификацию по определённому UUID (при помощи logout) для того, чтобы
    идентифицироваться по другому UUID или создать новый.
16. Сервис проверяет все вводимые данные, не допускает ввода некорректных значений,
    указывая пользователю как исправить ошибку при помощи информативных сообщений.

## Примеры использования:

1.  Пользователь хочет сократить ссылку: необходимо ввести полный URL ссылки в консоль
    вместе с указанием протокола (например https://). Если это первое обращение к сервису
    или иное обращение к сервису без предварительной идентификации по UUID, то для
    пользователя будет создан новый уникальный UUID, который нужно сохранить на будущее.
2.  Пользователь хочет идентифицироваться: нужно ввести команду login и параметр
    uuid_пользователя через пробел.
3.  Пользователь хочет снять идентификацию: нужно ввести команду logout.
4.  Пользователь хочет посмотреть статистику использования всех созданных им ссылок:
    нужно сначала идентифицироваться, а затем ввести команду stats.
5.  Пользователь хочет поменять лимит использований ссылки со стандартного
    на другое значение, тогда нужно ввести: manage URL_вашей_короткой_ссылки set limit 40
    (максимально устанавливаемое значение ограничено файлом конфигурации).
6.  Пользователь хочет удалить короткую ссылку: delete URL_вашей_короткой_ссылки.

## Список всех команд сервиса:
Для вывода помощи по отдельной команде можно ввести help имя_команды.

1.  login UUID - идентификация по имеющемуся UUID
2.  logout - снятие идентификации по UUID
3.  help - посмотреть помощь по всему сервису
4.  help имя_команды - посмотреть помощь по отдельной команде
5.  list - посмотреть список всех созданных от текущего UUID ссылок, которые сейчас активны
6.  stats - просмотреть статистику использований по всем активным ссылкам текущего UUID
7.  stats URL - просмотреть статистику по отдельной действующей короткой ссылке
8.  delete URL - удалить созданную ранее короткую ссылку
9.  manage URL set limit значение - изменить лимит использований короткой ссылки
10. manage URL set original_url значение - изменить URL, на который ведёт короткая ссылка
11. manage URL set ttl значение - изменить срок действия имеющейся короткой ссылки
12. config reload - перезагрузка настроек из файла
13. exit - выключение приложения
14. ввод URL без команды - сокращение длинного URL или переход по короткой ссылке сервиса
15. ввод URL без команды и без идентификации - также создаёт новый UUID

## Архитектура проекта:
Проект написан полностью в объектно-ориентированном стиле, с внедрением зависимостей через конструкторы. 
Реализуются принципы SOLID: конкретные сущности создаются на основе интерфейсов, работа осуществляется со ссылками
интерфейсных типов (dependency inversion); конкретные реализации обработчиков команд, репозиториев и т.д. полностью
совместимы с логикой, задаваемой их интерфейсами (LSP); классы имеют чёткую ответственность (SRP). Обработка отдельных
команд построена на основе паттерна "Команда" и отдельных объектах для обработчика каждой команды, что позволяет 
соблюдать принцип открытости / закрытости и удобно удалять и добавлять команды одной строкой.

Используется многослойная архитектура.
Классы разделены на слои:
- Presentation (CLI). Данный слой отвечает за взаимодействие с пользователем. Взаимодействие было разделено на три
  уровня: ConsoleController определяет тип запроса к сервису и направляет на нужный обработчик команды, одна из
  конкретных реализаций CommandHandler принимает запрос, проверяет синтаксис команды и далее направляет валидный по 
  формату запрос в один из сервисов. Полученный от сервиса результат оборачивается в структурированный объект типа
  ViewModel и направляется обратно в ConsoleController, который обращается к одной из реализаций Presenter для вывода
  результата запроса к сервису, например в консоль. Такая архитектура позволяет заменять Presenter с консоли на любой
  другой объект для вывода, а также создаёт удобные условия для тестирования результатов обработки каждой команды
  путём чтения содержимого объектов ViewModel или сопоставления их типов с ожидаемым.
- Application. В данный слой были помещены сервисы, содержащие методы, которые соответствуют отдельным сценариям
  использования системы: переход по ссылке, изменение параметров ссылки, создание ссылки, UUID, удаление ссылки,
  получение уведомления, получение списка всех ссылок и т.д. Реализованы три сервиса: LinkService, UserService 
  и NotificationService. Они являются фасадом для domain, управляют состоянием сущностей из domain и напрямую 
  обращаются к репозиториям сущностей, не позволяя другим объектам получать доступ к репозиториям извне. Таким образом,
  внутренняя логика обработки запросов и изменения состояния сервиса сосредоточена здесь.
- Domain. Слой задаёт основные сущности сервиса: короткую ссылку, пользователя и уведомление, все данные о сущностях 
  хранятся в их же объектах. Эти объекты также инкапсулируют важную логику взаимодействия с ними, например увеличение
  счётчика использования, проверку истечения срока действия: внешняя реализация данной логики могла бы ломать 
  правильное состояние объектов. Помимо этого, в данном слое содержатся интерфейсы репозиториев, задающие контракты
  работы с данными о пользователях, коротких ссылках и уведомлениях. Данный слой не зависит от прочих слоёв сервиса.
- Infrastructure. Здесь находятся классы, отвечающие за взаимодействие со внешними источниками информации 
  и за реализацию технических и служебных деталей сервиса. Так, здесь содержатся конкретные реализации репозиториев 
  (в нашем случае работающие в оперативной памяти), компонент FileStorageService, который отвечает за сериализацию 
  в файл и десериализацию из файла всех данных репозиториев сервиса, работает с json-файлами. Также здесь содержится 
  ConfigManager, сохраняющий и загружающий настройки. Помимо этого, здесь содержится реализация Runnable в виде
  LinkCheckStateTask - это периодически выполняемая фоновая задача, которая удаляет ссылки с истёкшим сроком действия,
  создаёт новые уведомления, показывает их пользователю и удаляет уже прочитанные уведомления.

Точка входа в приложение - класс Main, который запускает метод start() объекта UrlShortenerApp, отвечающего
за создание всех прочих ключевых объектов сервиса, передачу зависимостей и запуск бесконечного цикла ввода / вывода
через метод startListening() объекта ConsoleController.

## Дополнительные функции
Согласно ТЗ, обеспечивается глобальная уникальность коротких ссылок для всех пользователей. <br>
В течение одного запуска можно без ограничений идентифицироваться и снимать идентификацию по UUID 
любое количество раз. <br>
Устаревшие ссылки гарантированно удаляются из хранилища ссылок, удаление не отложено до определённых событий. <br>
Уведомления гарантированно доставляются владельцу ссылки вне зависимости от наличия или отсутствия его идентификации
в момент отправки уведомления, а также вне зависимости от статуса запуска сервиса на момент наступления события,
о котором должно приходить уведомление. <br>
Сервис сохраняет своё состояние между перезапусками. Можно работать с прежними UUID, ссылками, настройками и т.д.
после выключения и включения приложения. <br>
Настройки можно перезагружать без перезапуска сервиса. В файле настроек есть комментарий с помощью по отдельным
настраиваемым параметрам. <br>
Пользователь имеет лимит хранимых для него в моменте ссылок. При его достижении пользователю потребуется удалить 
лишние активные или заблокированные ссылки или подождать, пока истечёт срок действия старых ссылок, чтобы создать 
новые. <br>
Обеспечен удобный UX сокращения и перехода без ввода дополнительных команд. <br>

Также добавлено автоформатирование (Spotless) и дополнительные проверки стиля кода 
(Checkstyle по google-java-format).

## Установка и запуск
Проект собирается при помощи Gradle и использует библиотеку Jackson для работы с Json. Все зависимости проекта
включаются в jar файл.
Для сборки и запуска введите:
```bash
git clone https://github.com/yuyuvu/url-shortener-service.git
cd .\url-shortener-service
.\gradlew.bat build
cd .\build\libs
java -jar .\url-shortener-service-1.0.jar
```
Альтернативно можно скачать готовый jar файл из [релизов](https://github.com/yuyuvu/url-shortener-service/releases) и запустить его через:
```bash
java -jar .\url-shortener-service-1.0.jar
```

## Тестирование
В проект добавлено 26 интеграционных и юнит тестов (src/test). Они покрывают более 50% кода и всю ключевую логику сервиса. Отсутствуют только
тесты направления на обработчиков и валидации синтаксиса команд.
Тесты написаны с использованием библиотек JUnit и Mockito.

```bash
git clone https://github.com/yuyuvu/url-shortener-service.git
cd .\url-shortener-service
# Запуск тестов отдельно
.\gradlew.bat test
# Запуск тестов вместе со сборкой
.\gradlew.bat build
```

## CI
При каждом push или pull request в ветку main запускается пайплайн Github Actions, запускающий сборку через Gradle.
Применяется автоформатирование, проверяется стиль кода (Spotless, Checkstyle) и запускаются все тесты (JUnit с
использованием Mockito).
